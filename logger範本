// ğŸ“Œ logger.js - æ•´åˆèªéŸ³ç´€éŒ„ã€èº«åˆ†çµ„ã€è‡ªå‹•æ—¥èªŒé€šçŸ¥åŠŸèƒ½

const { Client, GatewayIntentBits, Partials, EmbedBuilder, Events, PermissionsBitField, SlashCommandBuilder, Collection } = require('discord.js');
const fs = require('fs');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildVoiceStates,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers
  ],
  partials: [Partials.Message, Partials.Channel, Partials.GuildMember, Partials.User]
});

const configFile = './config.json';
let config = fs.existsSync(configFile) ? JSON.parse(fs.readFileSync(configFile)) : {};

client.commands = new Collection();
const prefix = '!';

// =============================
// ğŸ§© å…±ç”¨æ–¹æ³•å€å¡Š
// =============================

function getHelpText() {
  return `ğŸ“ å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ï¼š

**ğŸ”¹ Slash æŒ‡ä»¤ï¼š**
/setvoice [èªéŸ³é »é“] â†’ è¨­å®šèªéŸ³ç›£æ§é »é“ï¼ˆç•¶æˆå“¡åŠ å…¥æ­¤é »é“æœƒåŠ ä¸Šèº«åˆ†çµ„ï¼‰
/setrole [èº«åˆ†çµ„] â†’ è¨­å®šè‡ªå‹•æŒ‡æ´¾çš„èº«åˆ†çµ„
/setlogchannel [é »é“] â†’ è¨­å®šç´€éŒ„æ—¥èªŒçš„é »é“ï¼ˆæ‰€æœ‰é€šçŸ¥å°‡ç™¼é€åˆ°æ­¤ï¼‰
/help â†’ é¡¯ç¤ºå¹«åŠ©æ¸…å–®

**ğŸ”¸ å‰ç¶´æŒ‡ä»¤ï¼ˆ${prefix}ï¼‰ï¼š**
${prefix}setvoice [èªéŸ³é »é“ID]  
${prefix}setrole [èº«åˆ†çµ„ID]  
${prefix}setlogchannel [é »é“ID]  
${prefix}help`;
}

function saveConfig() {
  fs.writeFileSync(configFile, JSON.stringify(config, null, 2));
}

function createLogEmbed(title, description) {
  return new EmbedBuilder()
    .setTitle(title)
    .setDescription(description)
    .setColor(0x00bfff)
    .setTimestamp();
}

function getMention(item) {
  return item ? `<#${item.id || item}>` : 'æœªè¨­å®š';
}

// =============================
// âš™ï¸ æŒ‡ä»¤è™•ç†å€å¡Š
// =============================

client.on(Events.InteractionCreate, async interaction => {
  if (!interaction.isChatInputCommand()) return;
  const { commandName, options, guildId } = interaction;

  if (!config[guildId]) config[guildId] = {};

  if (commandName === 'setvoice') {
    const channel = options.getChannel('channel');
    config[guildId].voiceChannel = channel.id;
    saveConfig();
    return interaction.reply({ content: `âœ… å·²è¨­å®šèªéŸ³é »é“ç‚ºï¼š${channel}`, ephemeral: true });
  }

  if (commandName === 'setrole') {
    const role = options.getRole('role');
    config[guildId].autoRole = role.id;
    saveConfig();
    return interaction.reply({ content: `âœ… å·²è¨­å®šè‡ªå‹•æŒ‡æ´¾èº«åˆ†çµ„ç‚ºï¼š${role}`, ephemeral: true });
  }

  if (commandName === 'setlogchannel') {
    const channel = options.getChannel('channel');
    config[guildId].logChannel = channel.id;
    saveConfig();
    return interaction.reply({ content: `ğŸ“˜ å·²è¨­å®šç´€éŒ„é »é“ç‚ºï¼š${channel}`, ephemeral: true });
  }

  if (commandName === 'help') {
    return interaction.reply({ content: getHelpText(), ephemeral: true });
  }
});

// =============================
// ğŸ™ï¸ èªéŸ³ç›£è½å€å¡Š
// =============================

client.on(Events.VoiceStateUpdate, async (oldState, newState) => {
  const guildId = newState.guild.id;
  const settings = config[guildId];
  if (!settings || !settings.logChannel) return;
  const logChannel = await newState.guild.channels.fetch(settings.logChannel);

  const user = newState.member;
  const mentionUser = `<@${user.id}>`;

  // åŠ å…¥èªéŸ³é »é“
  if (!oldState.channelId && newState.channelId) {
    if (newState.channelId === settings.voiceChannel && settings.autoRole) {
      const role = newState.guild.roles.cache.get(settings.autoRole);
      if (role) await user.roles.add(role).catch(() => {});
    }
    const embed = createLogEmbed('ğŸ“¥ ä½¿ç”¨è€…åŠ å…¥èªéŸ³é »é“', `${mentionUser} åŠ å…¥äº† ${getMention(newState.channel)}ã€‚`);
    logChannel.send({ embeds: [embed] });
  }

  // é›¢é–‹èªéŸ³é »é“
  if (oldState.channelId && !newState.channelId) {
    if (oldState.channelId === settings.voiceChannel && settings.autoRole) {
      const role = newState.guild.roles.cache.get(settings.autoRole);
      if (role) await user.roles.remove(role).catch(() => {});
    }
    const embed = createLogEmbed('ğŸ“¤ ä½¿ç”¨è€…é›¢é–‹èªéŸ³é »é“', `${mentionUser} é›¢é–‹äº† ${getMention(oldState.channel)}ã€‚`);
    logChannel.send({ embeds: [embed] });
  }

  // é »é“ç§»å‹•
  if (oldState.channelId && newState.channelId && oldState.channelId !== newState.channelId) {
    const embed = createLogEmbed('ğŸ” ä½¿ç”¨è€…ç§»å‹•èªéŸ³é »é“', `${mentionUser} å¾ ${getMention(oldState.channel)} ç§»å‹•åˆ° ${getMention(newState.channel)}ã€‚`);
    logChannel.send({ embeds: [embed] });
  }

  // è‡ªæˆ‘éœéŸ³ / æ‹’è½
  if (oldState.selfMute !== newState.selfMute) {
    const embed = createLogEmbed(newState.selfMute ? 'ğŸ”‡ è‡ªæˆ‘éœéŸ³' : 'ğŸ”Š å–æ¶ˆè‡ªæˆ‘éœéŸ³', `${mentionUser} ${newState.selfMute ? 'å•Ÿç”¨äº†' : 'å–æ¶ˆäº†'} è‡ªæˆ‘éœéŸ³ã€‚`);
    logChannel.send({ embeds: [embed] });
  }
  if (oldState.selfDeaf !== newState.selfDeaf) {
    const embed = createLogEmbed(newState.selfDeaf ? 'ğŸ™‰ è‡ªæˆ‘æ‹’è½' : 'ğŸ‘‚ å–æ¶ˆè‡ªæˆ‘æ‹’è½', `${mentionUser} ${newState.selfDeaf ? 'å•Ÿç”¨äº†' : 'å–æ¶ˆäº†'} è‡ªæˆ‘æ‹’è½ã€‚`);
    logChannel.send({ embeds: [embed] });
  }

  // è¢«ç®¡ç†è€…éœéŸ³ / æ‹’è½
  if (oldState.serverMute !== newState.serverMute) {
    const embed = createLogEmbed(newState.serverMute ? 'ğŸ”‡ è¢«éœéŸ³' : 'ğŸ”Š è¢«è§£é™¤éœéŸ³', `${mentionUser} ${newState.serverMute ? 'è¢«ä¼ºæœå™¨éœéŸ³ã€‚' : 'è¢«è§£é™¤ä¼ºæœå™¨éœéŸ³ã€‚'}`);
    logChannel.send({ embeds: [embed] });
  }
  if (oldState.serverDeaf !== newState.serverDeaf) {
    const embed = createLogEmbed(newState.serverDeaf ? 'ğŸ™‰ è¢«æ‹’è½' : 'ğŸ‘‚ è¢«è§£é™¤æ‹’è½', `${mentionUser} ${newState.serverDeaf ? 'è¢«ä¼ºæœå™¨æ‹’è½ã€‚' : 'è¢«è§£é™¤ä¼ºæœå™¨æ‹’è½ã€‚'}`);
    logChannel.send({ embeds: [embed] });
  }
});

// =============================
// ğŸš· æˆå“¡ç‹€æ…‹è®Šæ›´ï¼ˆè¸¢å‡ºèªéŸ³ï¼‰
// =============================

client.on(Events.GuildMemberUpdate, async (oldMember, newMember) => {
  const guildId = newMember.guild.id;
  const settings = config[guildId];
  if (!settings || !settings.logChannel) return;
  
  const logChannel = await newMember.guild.channels.fetch(settings.logChannel);
  const oldVoiceChannel = oldMember.voice?.channel;
  const newVoiceChannel = newMember.voice?.channel;

  // æª¢æŸ¥æ˜¯å¦å¾èªéŸ³é »é“è¢«è¸¢å‡ºï¼ˆèˆŠæœ‰é »é“ â†’ æ–°é »é“ç‚º nullï¼‰
  if (oldVoiceChannel && !newVoiceChannel) {
    const embed = createLogEmbed(
      'ğŸš· ä½¿ç”¨è€…è¢«è¸¢å‡ºèªéŸ³é »é“',
      `<@${newMember.id}> è¢«å¼·åˆ¶ç§»å‡ºèªéŸ³é »é“ ${getMention(oldVoiceChannel)}ã€‚`
    );
    logChannel.send({ embeds: [embed] });
  }
});


// =============================
// ğŸ—‘ï¸ è¨Šæ¯åˆªé™¤ç´€éŒ„
// =============================

client.on(Events.MessageDelete, async message => {
  const guildId = message.guild?.id;
  const settings = config[guildId];
  if (!settings || !settings.logChannel || message.partial) return;

  const logChannel = await message.guild.channels.fetch(settings.logChannel);
  const embed = new EmbedBuilder()
    .setTitle('ğŸ—‘ï¸ è¨Šæ¯è¢«åˆªé™¤')
    .addFields(
      { name: 'ğŸ‘¤ ç™¼é€è€…', value: `${message.author}`, inline: true },
      { name: 'ğŸ“ é »é“', value: `${message.channel}`, inline: true },
      { name: 'ğŸ’¬ åŸå§‹è¨Šæ¯', value: message.content || 'ï¼ˆå¯èƒ½ç‚ºåœ–ç‰‡ã€åµŒå…¥æˆ–å…¶ä»–éæ–‡å­—å…§å®¹ï¼‰' }
    )
    .setColor(0xff4d4d)
    .setTimestamp();

  if (message.attachments.size > 0) {
    embed.setImage(message.attachments.first().url);
  }

  logChannel.send({ embeds: [embed] });
});

// =============================
// âœ… Bot å•Ÿå‹• & æŒ‡ä»¤è¨»å†Šï¼ˆåˆå§‹ï¼‰
// =============================

client.once(Events.ClientReady, async () => {
  console.log(`ğŸ¤– å·²ç™»å…¥ ${client.user.tag}`);

  const commands = [
    new SlashCommandBuilder()
      .setName('setvoice')
      .setDescription('è¨­å®šèªéŸ³ç›£æ§é »é“')
      .addChannelOption(opt => opt.setName('channel').setDescription('é¸æ“‡èªéŸ³é »é“').setRequired(true)),
    new SlashCommandBuilder()
      .setName('setrole')
      .setDescription('è¨­å®šè‡ªå‹•æŒ‡æ´¾èº«åˆ†çµ„')
      .addRoleOption(opt => opt.setName('role').setDescription('é¸æ“‡èº«åˆ†çµ„').setRequired(true)),
    new SlashCommandBuilder()
      .setName('setlogchannel')
      .setDescription('è¨­å®šç´€éŒ„ç”¨çš„é »é“')
      .addChannelOption(opt => opt.setName('channel').setDescription('é¸æ“‡ç´€éŒ„é »é“').setRequired(true)),
    new SlashCommandBuilder()
      .setName('help')
      .setDescription('é¡¯ç¤ºæ‰€æœ‰æŒ‡ä»¤èˆ‡ç”¨æ³•')
  ];

  const guilds = client.guilds.cache.map(guild => guild.id);
  for (const id of guilds) {
    await client.application.commands.set(commands, id);
  }
});

module.exports = { client };


import { SlashCommandBuilder } from 'discord.js';

export const loggerSlashCommands = [
  new SlashCommandBuilder().setName('voicelog').setDescription('æŸ¥è©¢æœ€è¿‘çš„èªéŸ³é€²å‡ºç´€éŒ„'),
  new SlashCommandBuilder().setName('selfmute').setDescription('æŸ¥è©¢ä½¿ç”¨è€…é–‹/é—œéº¥å…‹é¢¨ç´€éŒ„'),
  new SlashCommandBuilder().setName('modmute').setDescription('æŸ¥è©¢è¢«ç®¡ç†å“¡éœéŸ³/æ‹’è½çš„ç´€éŒ„'),
  new SlashCommandBuilder().setName('deletelog').setDescription('æŸ¥è©¢è¨Šæ¯èˆ‡åœ–ç‰‡åˆªé™¤ç´€éŒ„')
];
